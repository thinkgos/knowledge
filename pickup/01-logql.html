<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>logql - knowledge</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">knowledge</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/thinkgos/knowledge" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="logql-log-query-language"><a class="header" href="#logql-log-query-language">LogQL: Log query language</a></h1>
<h2 id="1-overview"><a class="header" href="#1-overview">1. Overview</a></h2>
<p><code>LogQL</code> 是 Grafana Loki 的受 <code>promql</code> 启发的查询语言. 查询的行为就好像它们是聚合日志源的分布式 grep. <code>LogQL</code> 使用标签和运算符进行过滤.</p>
<p>有两种类型的 LogQL 查询:</p>
<ul>
<li>[Log queries](#二. Log queries  ) 返回日志行的内容.</li>
<li>[Metric queries](#三. Metric queries) 基于扩展日志查询结果来计算值</li>
</ul>
<h3 id="二元操作符"><a class="header" href="#二元操作符">二元操作符</a></h3>
<h4 id="算术操作符"><a class="header" href="#算术操作符">算术操作符</a></h4>
<ul>
<li><code>+</code> (addition)</li>
<li><code>-</code> (subtraction)</li>
<li><code>*</code> (multiplication)</li>
<li><code>/</code> (division)</li>
<li><code>%</code> (modulo)</li>
<li><code>^</code> (power/exponentiation)</li>
</ul>
<h4 id="逻辑和集合运算符"><a class="header" href="#逻辑和集合运算符">逻辑和集合运算符</a></h4>
<ul>
<li><code>and</code> (intersection)</li>
<li><code>or</code> (union)</li>
<li><code>unless</code> (complement)</li>
</ul>
<h4 id="比较运算符"><a class="header" href="#比较运算符">比较运算符</a></h4>
<ul>
<li><code>==</code> (equality)</li>
<li><code>!=</code> (inequality)</li>
<li><code>&gt;</code> (greater than)</li>
<li><code>&gt;=</code> (greater than or equal to)</li>
<li><code>&lt;</code> (less than)</li>
<li><code>&lt;=</code> (less than or equal to)</li>
</ul>
<h4 id="关键字-on-和-ignoring"><a class="header" href="#关键字-on-和-ignoring">关键字 on 和 ignoring</a></h4>
<h3 id="注释"><a class="header" href="#注释">注释</a></h3>
<p>使用 <code>#</code> 注释</p>
<h2 id="二-log-queries"><a class="header" href="#二-log-queries">二. Log queries</a></h2>
<pre><code class="language-text">                _ optional log pipeline _
               /                          \
                filter operator 
                 |=    \
                 !=     |  line filter expression
                 |~     |  
                 !~    /
 
 { stream selector }
                =       \
                !=       |
                =~        \  label filter
                !~        /  expression
                &gt;   &gt;=    |
                &lt;   &lt;=   /
            
            parser expression
            line format expressin 
            label format expression
</code></pre>
<h3 id="日志流选择器log-stream-selector"><a class="header" href="#日志流选择器log-stream-selector">日志流选择器(Log stream selector)</a></h3>
<p>流选择器确定要在查询结果中包含哪些日志流. 日志流是日志内容的唯一来源, 例如文件.</p>
<p>日志流选择器由一个或多个<strong>逗号</strong>分隔的键值对指定, 大括号(<code>{</code> and <code>}</code>)分隔流选择器.</p>
<p>支持以下标签匹配运算符:</p>
<ul>
<li><code>=</code>: exactly equal</li>
<li><code>!=</code>: not equal</li>
<li><code>=~</code>: regex matches</li>
<li><code>!~</code>: regex does not match</li>
</ul>
<h3 id="日志管道log-pipeline"><a class="header" href="#日志管道log-pipeline">日志管道(Log pipeline)</a></h3>
<p>日志管道可以附加到日志流选择器以进一步处理和过滤日志流. 它是由一组表达式组成的. 对于每个日志行, 每个表达式按从左到右的顺序执行. 如果表达式过滤掉一条日志行, 则管道将停止处理当前日志行, 并开始处理下一条日志行.</p>
<p>日志管道表达式可分为三类:</p>
<ul>
<li>过滤表达式: [行过滤](#行过滤(Line filter expression))和[标签过滤](#标签过滤(Label filter expressions))</li>
<li>解析表达式</li>
<li>格式化表达式: <a href="##">line format expressions</a> and <a href="##">label format expressions</a></li>
</ul>
<h4 id="行过滤line-filter-expression"><a class="header" href="#行过滤line-filter-expression">行过滤(Line filter expression)</a></h4>
<p>行过滤表达式支持以下匹配运算符:</p>
<ul>
<li><code>|=</code>: Log line contains string</li>
<li><code>!=</code>: Log line does not contain string</li>
<li><code>|~</code>: Log line contains a match to the regular expression</li>
<li><code>!~</code>: Log line does not contain a match to the regular expression</li>
</ul>
<h4 id="标签过滤label-filter-expressions"><a class="header" href="#标签过滤label-filter-expressions">标签过滤(Label filter expressions)</a></h4>
<p>标签过滤器表达式允许使用原始和提取的标签过滤日志行,它可以包含多个谓词.</p>
<p>谓词包含一个标签标识符、一个操作和一个要进行比较的标签值.</p>
<p>我们支持从查询输入自动推断的多个值类型</p>
<ul>
<li><strong>String</strong>是用双引号或反引号</li>
<li><strong><a href="https://golang.org/pkg/time/#ParseDuration">Duration</a></strong> 有效的时间单位: “ns”, “us” (or “µs”), “ms”, “s”, “m”, “h”.</li>
<li><strong>Number</strong></li>
<li><strong>Bytes</strong>有效的字节单位: “b”, “kib”, “kb”, “mib”, “mb”, “gib”, “gb”, “tib”, “tb”, “pib”, “pb”, “eib”, “eb”.</li>
</ul>
<p><strong>String</strong>类型与Prometheus的标签选择器一致, 可以使用相同的操作(<code>=</code>,<code>!=</code>,<code>=~</code>,<code>!~</code>)</p>
<blockquote>
<p>The string type is the only one that can filter out a log line with a label <code>__error__</code>.</p>
</blockquote>
<p>使用 <strong>Duration</strong>, <strong>Number</strong> 和 <strong>Bytes</strong> 将在比较之前转换标签值, 并支持以下比较器:</p>
<ul>
<li><code>==</code> or <code>=</code> for equality.</li>
<li><code>!=</code> for inequality.</li>
<li><code>&gt;</code> and <code>&gt;=</code> for greater than and greater than or equal.</li>
<li><code>&lt;</code> and <code>&lt;=</code> for lesser than and lesser than or equal.</li>
</ul>
<h4 id="解析器"><a class="header" href="#解析器">解析器</a></h4>
<p>解析器表达式可以从日志内容中解析和提取标签. 然后可以使用提取的标签来使用标签筛选器表达式进, 或者用于度量聚合.</p>
<p>Loki 支持 <a href="https://grafana.com/docs/loki/latest/logql/log_queries/#json">JSON</a>, <a href="https://grafana.com/docs/loki/latest/logql/log_queries/#logfmt">logfmt</a>, <a href="https://grafana.com/docs/loki/latest/logql/log_queries/#pattern">pattern</a>, <a href="https://grafana.com/docs/loki/latest/logql/log_queries/#regular-expression">regexp</a> and <a href="https://grafana.com/docs/loki/latest/logql/log_queries/#unpack">unpack</a> parsers.</p>
<h5 id="json"><a class="header" href="#json">JSON</a></h5>
<p>JSON解析器支持两种模式</p>
<ul>
<li>无参数</li>
</ul>
<p>如果日志行是有效的 json 文档, 那么向管道添加<code>| json</code>将提取所有 json 属性作为标签, NOTE: 数组将被忽略</p>
<ul>
<li>有参数</li>
</ul>
<p>如果日志行是有效的 json 文档, 那么向管道添加<code>| json label="expression1", another="expression2"</code>将提取指 json 属性作为标签.</p>
<h5 id="logfmt"><a class="header" href="#logfmt">logfmt</a></h5>
<p>可以使用<code>| logfmt</code> 添加 logfmt 解析器, 并从 logfmt 格式化的日志行中提取所有键和值.</p>
<h5 id="pattern"><a class="header" href="#pattern">Pattern</a></h5>
<p>模式分析器通过定义模式表达式(<code>| pattern”&lt; pattern-expression &gt;”</code>) , 允许从日志行显式提取字段. 表达式匹配日志行的结构.</p>
<blockquote>
<p>考虑该NGINX的日志行</p>
<pre><code class="language-log">0.191.12.2 - - [10/Jun/2021:09:14:29 +0000] "GET /api/plugins/versioncheck HTTP/1.1" 200 2 "-" "Go-http-client/2.0" "13.76.247.102, 34.120.177.193" "TLSv1.2" "US" ""
</code></pre>
<p><code>&lt;ip&gt; - - &lt;_&gt; "&lt;method&gt; &lt;uri&gt; &lt;_&gt;" &lt;status&gt; &lt;size&gt; &lt;_&gt; "&lt;agent&gt;" &lt;_&gt;</code></p>
<p>上面模式表达式将提取这些字段：</p>
<pre><code class="language-kv">"ip" =&gt; "0.191.12.2"
"method" =&gt; "GET"
"uri" =&gt; "/api/plugins/versioncheck"
"status" =&gt; "200"
"size" =&gt; "2"
"agent" =&gt; "Go-http-client/2.0"
</code></pre>
</blockquote>
<p>模式表达式由捕获和文本组成.</p>
<p>捕获是由 <code>&lt;</code> 和 <code>&gt;</code> 字符分隔的字段名. 一位匿名的捕获显示为<code>&lt;_&gt;</code>.</p>
<h5 id="regular-expression"><a class="header" href="#regular-expression">Regular expression</a></h5>
<p>与 logfmt 和 json (隐式地提取所有值并且不带参数)不同, regexp 解析器采用单个参数 <code>| regexp“ &lt; re &gt;”</code></p>
<h5 id="unpack"><a class="header" href="#unpack">unpack</a></h5>
<p>解析器解析 JSON 日志行, 解压打包阶段中的所有嵌入标签. 还将使用一个特殊属性 **<code>_entry</code>**来替换原始日志行.</p>
<h4 id="行格式表达式line-format-expression"><a class="header" href="#行格式表达式line-format-expression">行格式表达式(Line format expression)</a></h4>
<p>行格式表达式可以使用 <a href="https://golang.org/pkg/text/template/">text/template</a>格式重写日志行内容, 它只接受一个字符串参数<code>| line_format "{{.label_name}}"</code>,所有标签都是注入到模板中的变量, 可以使用{{ . label _ name }}符号.</p>
<h4 id="标签格式表达式labels-format-expression"><a class="header" href="#标签格式表达式labels-format-expression">标签格式表达式(Labels format expression)</a></h4>
<p><code>| label _ format</code> 表达式可以重命名、修改或添加标签. 它接受一个逗号分隔的等式操作列表作为参数, 以便一次执行多个操作.</p>
<p>当两端都是标签标识符(例如 dst = src)时, 操作将把 src 标签重命名为 dst.</p>
<p>左边也可以是模板字符串(双引号或反勾号) , 例如 <code>dst = “{{.status}} {{.query}}”</code>, 在这种情况下, dst 标签值被文本/模板计算的结果替换. 这是与<code>| line _ format</code>表达式相同的模板引擎, 这意味着标签可以作为变量使用, 您可以使用相同的函数列表.</p>
<p>在这两种情况下, 如果目标标签不存在, 则创建一个新的目标标签.</p>
<p>重命名表单 dst = src 将在重新映射到 dst 标签后删除 src 标签. 但是, 模板将保留引用的标签, 例如 <code>dst="{{.src}}"</code>,结果在 dst 和 src 具有相同的值</p>
<h2 id="三-metric-queries"><a class="header" href="#三-metric-queries">三. Metric queries</a></h2>
<h2 id="四-template-function"><a class="header" href="#四-template-function">四. Template function</a></h2>
<h2 id="五-matching-ip-addresses"><a class="header" href="#五-matching-ip-addresses">五. Matching IP addresses</a></h2>
<h2 id="六-query-example"><a class="header" href="#六-query-example">六. Query Example</a></h2>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../pickup/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../pickup/02-promql.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../pickup/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../pickup/02-promql.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>



        <script>
            window.playground_line_numbers = true;
        </script>

        <script>
            window.playground_copyable = true;
        </script>

        <script src="../ace.js"></script>
        <script src="../mode-rust.js"></script>
        <script src="../editor.js"></script>
        <script src="../theme-dawn.js"></script>
        <script src="../theme-tomorrow_night.js"></script>

        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
