<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>nats - knowledge</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">knowledge</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/thinkgos/knowledge" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="nats"><a class="header" href="#nats">NATS</a></h1>
<p>特性:</p>
<ul>
<li>Core NATS</li>
<li>JetStream</li>
</ul>
<p>优势:</p>
<ul>
<li>边缘与云原生消息系统, <code>CNCF</code>毕业项目, 社区活跃度高, 文档完善.</li>
<li><code>golang</code>编写, 服务端程序极小, 不到20M.</li>
<li>支持客户端的语言非常多, 主流语言基本都支持.</li>
<li>支持内存级的<code>Core NATS</code>, 有发布-订阅, 请求-回复(类似RPC), 队列组等功能</li>
<li>支持持久化的<code>JetStream</code>, 在<code>Core NATS</code>之上提供消息持久化, 消息确认, 消息重试, 消息保序等机制, 另外还提供<code>Key-Value</code>存储, 对象存储功能.
<ul>
<li>每一个<code>Stream</code>独立提供丰富的配置</li>
<li>每一个<code>Stream</code>的每一个<code>Consumer</code>独立提供丰富配置</li>
</ul>
</li>
<li>支持安全的身份验证和授权访问机制, 支持TLS, JWT-based zero trust security</li>
<li>支持集群, 可以水平扩展, 提供高可用, 高并发的消息系统</li>
<li>协议层面支持 TCP, MQTT, WebSockets</li>
</ul>
<h2 id="1-core-nats"><a class="header" href="#1-core-nats">1. Core NATS</a></h2>
<h3 id="11-publish-subscribe发布-订阅"><a class="header" href="#11-publish-subscribe发布-订阅">1.1 Publish-Subscribe(发布-订阅)</a></h3>
<p><img src="https://docs.nats.io/~gitbook/image?url=https%3A%2F%2F1487470910-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252F-LqMYcZML1bsXrN3Ezg0%252Fuploads%252Fgit-blob-22d59af386038cc2717176561ffc95c63c295926%252Fpubsub.svg%3Falt%3Dmedia&amp;width=768&amp;dpr=4&amp;quality=100&amp;sign=1a700ae8&amp;sv=2" alt="ps" /></p>
<h3 id="12-request-reply请求-回复"><a class="header" href="#12-request-reply请求-回复">1.2 Request-Reply(请求-回复)</a></h3>
<p><img src="https://docs.nats.io/~gitbook/image?url=https%3A%2F%2F1487470910-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252F-LqMYcZML1bsXrN3Ezg0%252Fuploads%252Fgit-blob-dc10798d4afca301adba55c1e85c599b25a2ae24%252Freqrepl.svg%3Falt%3Dmedia&amp;width=768&amp;dpr=4&amp;quality=100&amp;sign=4fdca5ce&amp;sv=2" alt="rr" /></p>
<h3 id="13-queuegroup队列组"><a class="header" href="#13-queuegroup队列组">1.3 QueueGroup(队列组)</a></h3>
<p><img src="https://docs.nats.io/~gitbook/image?url=https%3A%2F%2F1487470910-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252F-LqMYcZML1bsXrN3Ezg0%252Fuploads%252Fgit-blob-62652b3e6dd556e3cb1c3bb474ec10038334c600%252Fqueue.svg%3Falt%3Dmedia&amp;width=768&amp;dpr=4&amp;quality=100&amp;sign=ab76b046&amp;sv=2" alt="qg" /></p>
<h2 id="2-jetstream"><a class="header" href="#2-jetstream">2. JetStream</a></h2>
<p><code>JetStream</code>在<code>Core NATS</code>基本功能的基础上实现新的功能和更高的服务质量.</p>
<h3 id="21-streams"><a class="header" href="#21-streams">2.1 Streams</a></h3>
<h4 id="211-replay-policies重放策略"><a class="header" href="#211-replay-policies重放策略">2.1.1 Replay policies(重放策略)</a></h4>
<p>JetStream 消费者支持多种重放策略, 具体取决于消费应用程序是否希望接收策略:</p>
<ul>
<li>存储在<code>stream</code>中的所有消息, 可以完整重放, 也可以选择重放策略(即重放速度):
<ul>
<li><code>instant</code>: (以最快的速度向消费者发送消息).</li>
<li><code>original</code>: (这意味着消息将以发布到流中的速度传送给消费者, 这对于暂存生产流量非常有用. )</li>
</ul>
</li>
<li>存储在<code>stream</code>中的最后一条消息, 或每个主题的最后一条消息 (因为流可以捕获多个主题).</li>
<li>从特定序列号开始.</li>
<li>从特定的开始时间开始.</li>
</ul>
<h4 id="212-retention-policies-and-limits保留政策和限制"><a class="header" href="#212-retention-policies-and-limits保留政策和限制">2.1.2 Retention policies and limits(保留政策和限制)</a></h4>
<h5 id="2121-limits限制"><a class="header" href="#2121-limits限制">2.1.2.1 Limits(限制)</a></h5>
<p>你可以对<code>stream</code>施加以下限制:</p>
<ul>
<li>最大消息年龄</li>
<li><code>stream</code>的最大总大小(字节)</li>
<li><code>stream</code>的消息最大总数量</li>
<li>单条消息的最大大小</li>
<li>还可以设置在任何给定时间点为<code>stream</code>定义的消费者数量限制</li>
</ul>
<p>您还必须选择一个丢弃策略, 该策略规定了一旦<code>stream</code>达到其限制之一并有新消息发布时应该发生的情况:</p>
<ul>
<li><code>discard old</code>: 表示<code>stream</code>将自动删除<code>stream</code>中最旧的消息, 为新消息腾出空间.</li>
<li><code>discard new</code>: 表示丢弃新消息 (JetStream 发布调用会返回错误消息, 表明已达到限制).</li>
</ul>
<h5 id="2122-retention-policy保留策略"><a class="header" href="#2122-retention-policy保留策略">2.1.2.2 Retention policy(保留策略)</a></h5>
<p>您可以为每个<code>stream</code>选择所需的保留策略:</p>
<ul>
<li><code>limits</code>:  (默认)是提供流中消息的重播.</li>
<li><code>work queue</code>: 来提供<code>stream</code>中消息的只有一次的消费(消息流被用作共享队列, 消息被消费时会从队列中移除).</li>
<li><code>interest</code>: 是工作队列的一种变体, 它只保留对消息主题有兴趣 (流上当前定义的消费者)的消息. (只要有消费者尚未发送消息, 消息流中就会一直保留消息)</li>
</ul>
<p>请注意, 无论选择哪种保留策略, <code>Limits</code> (和丢弃策略)始终生效.</p>
<h4 id="213-persistent-and-consistent-distributed-storage持久且一致的分布式存储"><a class="header" href="#213-persistent-and-consistent-distributed-storage持久且一致的分布式存储">2.1.3 Persistent and Consistent distributed storage(持久且一致的分布式存储)</a></h4>
<p>您可以根据自己的需要选择消息存储的持久化和弹性.</p>
<ul>
<li><code>Memory storage</code>.</li>
<li><code>File storage</code>.</li>
<li><code>Replication</code> (1 (none), 2, 3) between nats servers for Fault Tolerance.</li>
</ul>
<h3 id="22-consumers消费者"><a class="header" href="#22-consumers消费者">2.2 Consumers(消费者)</a></h3>
<p><code>Core NATS</code>提供最多一次的交付保证, 而<code>JetStream</code>的消费者则不同, 它可以提供至少一次的交付保证.</p>
<h4 id="221-dispatch-type---pullpush分发类型---拉模式推模式"><a class="header" href="#221-dispatch-type---pullpush分发类型---拉模式推模式">2.2.1 Dispatch type - Pull/Push(分发类型 - 拉模式/推模式)</a></h4>
<ul>
<li><code>push</code>: 基于推送模式的, 即向指定主题发送消息</li>
<li><code>pull</code>: 基于拉模式的, 即允许客户按需请求批量消息</li>
</ul>
<h4 id="222-ordered-consumers有序消费者"><a class="header" href="#222-ordered-consumers有序消费者">2.2.2 Ordered Consumers(有序消费者)</a></h4>
<p>有序消费者是推/拉消费者的默认类型, 专为希望有效消费数据流以进行数据检查或分析的应用程序而设计.</p>
<ul>
<li>总是短暂的</li>
<li>无确认（如果检测到间隙, 则重新创建消费者）</li>
<li>自动流量控制/拉动处理</li>
<li>单线程调度</li>
<li>无负载平衡</li>
</ul>
<h4 id="223-persistence---durableephemeral持久性---持久短暂"><a class="header" href="#223-persistence---durableephemeral持久性---持久短暂">2.2.3 Persistence - Durable/Ephemeral(持久性 - 持久/短暂)</a></h4>
<p>除了可以选择推式或拉式外, 消费者还可以是短暂的或持久的.</p>
<h3 id="224-ackpolicy应答策略"><a class="header" href="#224-ackpolicy应答策略">2.2.4 AckPolicy(应答策略)</a></h3>
<p>策略选择包括:</p>
<ul>
<li><code>AckExplicit</code>:  默认策略. 每条报文都必须确认. 建议使用该策略以获得最高的可靠性和功能性.</li>
<li><code>AckNone</code>: 不需要确认；服务器假定在发送时确认.</li>
<li><code>AckAll</code>: 只确认系列中收到的最后一条信息；之前的所有信息都会自动确认. 将确认 Pull Consumer 所有订阅者的所有待确认信息.</li>
</ul>
<p>如果需要确认, 但在<code>AckWait</code>窗口内未收到, 则会重新发送报文.</p>
<h3 id="225-deliverpolicy分发策略"><a class="header" href="#225-deliverpolicy分发策略">2.2.5 DeliverPolicy(分发策略)</a></h3>
<p>策略选择包括:</p>
<ul>
<li><code>DeliverAll</code>: 默认策略. 从信息流中最早可用的信息开始接收.</li>
<li><code>DeliverLast</code>: 从流中添加的最后一条信息开始接收, 或从符合消费者筛选主题（如果已定义）的最后一条信息开始接收.</li>
<li><code>DeliverLastPerSubject</code>: 从当前信息流中每个过滤主题的最新信息开始接收.</li>
<li><code>DeliverNew</code>: 开始接收消费者创建后创建的信息.</li>
<li><code>DeliverByStartSequence</code>: 从具有指定序列号的第一条信息开始. 消费者必须指定定义序列号的<code>OptStartSeq</code>.</li>
<li><code>DeliverByStartTime</code>: 从指定时间或之后的信息开始接收. 消费者必须指定定义开始时间的<code>OptStartTime</code>.</li>
</ul>
<h3 id="226-maxackpending"><a class="header" href="#226-maxackpending">2.2.6 MaxAckPending</a></h3>
<p><code>MaxAckPending</code>功能提供流量控制, 同时适用于推式和拉式消费者.
对于推送消费者, <code>MaxAckPending</code>是唯一的流量控制形式.
对于拉式消费者, 客户端驱动的消息传递会与订阅者建立隐式一对一流量控制.
为获得高吞吐量, 请将 <code>MaxAckPending</code>设置为较高值.对于因外部服务导致延迟较高的应用, 可使用较低的值并调整 <code>AckWait</code> 以避免重新交付.</p>
<h3 id="227-filtersubjects"><a class="header" href="#227-filtersubjects">2.2.7 FilterSubjects</a></h3>
<p>过滤主题可在向客户端发送信息前对信息进行服务器端过滤.</p>
<h2 id="3-jetstream例子"><a class="header" href="#3-jetstream例子">3. JetStream例子</a></h2>
<h3 id="创建一个stream"><a class="header" href="#创建一个stream">创建一个<code>stream</code></a></h3>
<pre><code class="language-shell">nats stream add \
    com_msg \                               &lt;-- stream名称
    --subjects "com.msg.*" \                &lt;-- 订阅的主题
    --storage file \                        &lt;-- 存储类型, file/memory
    --retention "work" \                    &lt;-- 保留策略, limits/interest/work  
    --discard old \                         &lt;-- 丢弃策略, old/new, 当消息达到限制数据后, 如何处理消息
    --max-msgs -1 \                         &lt;-- 最大消息数量, -1 表示无限制
    --max-msgs-per-subject -1 \             &lt;-- 每个主题的最大消息数量, -1 表示无限制, 超过限制按丢弃策略处理
    --max-bytes -1 \                        &lt;-- 所有消息总的最大大小, -1 表示无限制
    --max-msg-size -1 \                     &lt;-- 单条消息的最大大小, -1 表示无限制
    --max-ages 1y \                         &lt;-- 最大消息年龄, 超过限制按丢弃策略处理
    --dupe-window 2m0s \                    &lt;-- 重复消息窗口, 根据Msg-Id的header头信息判断唯一消息的时间
    --no-allow-rollup \                     &lt;-- 是否允许通过header卷起消息, --allow-rollup为允许
    --deny-delete \                         &lt;-- 是否允许通过API删除消息, --no-deny-delete为允许
    --deny-purge \                          &lt;-- 是否允许通过API清除消息, --no-deny-purge为允许
    --replicas                              &lt;-- 消息副本数, 集群使用
</code></pre>
<h4 id="创建一个consumer"><a class="header" href="#创建一个consumer">创建一个<code>Consumer</code></a></h4>
<pre><code class="language-shell">nats consumer add \
    com_msg \                           &lt;-- stream名称
    com_msg_consumer \                  &lt;-- consumer名称
    --filter-subject "com.msg.*" \      &lt;-- 过滤stream中的主题
    --deliver all \                     &lt;-- 如何处理stream中的消息, 见下表
    --ack explicit \                    &lt;-- 消息确认方式, none/all/explicit
    --replay instant \                  &lt;-- 消息重放机制, instant/original
    --max-deliver -1 \                  &lt;-- 最大交付次数, -1 表示没有正确的ack就不停的投递消息
    --max-pending 0 \                   &lt;-- 最多允许存在多少条未投递成功, 正在重新投递的消息, 如果达到这个数, 将不再投递新消息
    --headers-only \                    &lt;-- 是否只投递header信息
    --target ""                         &lt;-- 推模式目标, 拉模式为空
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../pickup/85-glob.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../pickup/100-git.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../pickup/85-glob.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../pickup/100-git.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>



        <script>
            window.playground_line_numbers = true;
        </script>

        <script>
            window.playground_copyable = true;
        </script>

        <script src="../ace.js"></script>
        <script src="../mode-rust.js"></script>
        <script src="../editor.js"></script>
        <script src="../theme-dawn.js"></script>
        <script src="../theme-tomorrow_night.js"></script>

        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
