# NAT type 网络类型

- `Full Cone NAT`: 任意外部主机都能通过映射端口访问
- `Restricted Cone NAT`: 只有与内网主机通信过的外部IP才能访问
- `Port Restricted Cone NAT`: 必须与相同IP+PORT通信过的外部主机才能访问
- `Symmetric NAT`: 不同外部目标地址生成不同映射端口

## 四种NAT类型

### Full Cone NAT(全锥形NAT)

所有外部主机, 只要知道公网IP和端口, 就能访问到内部主机. 不限制来源IP或端口. 映射是固定的(只要建立过一次连接), 外部任意主机都可以复用这条映射. P2P最容易打通.

```less
内网主机A (192.168.1.2:1234)
        |
        | NAT 映射表：
        |   192.168.1.2:1234 → 203.0.113.5:50000
        v
    +-----------+
    |  NAT网关  |  ← 公网IP:203.0.113.5
    +-----------+
        |
        v
        外部主机B 任意IP任意端口 → 203.0.113.5:50000
                        ↓
                        转发到 192.168.1.2:1234
```

### Restricted Cone NAT(限制锥形NAT)

内网主机发出请求后, 外部主机只有在相同IP(任意端口)下才能访问回来. NAT会限制外部IP.

```less
内网主机A(192.168.1.2:1234) → B(1.1.1.1:80)
        |
        | NAT 映射表：
        |   192.168.1.2:1234 → 203.0.113.5:50000
        v
    +-----------+
    | NAT网关   |
    +-----------+
        |
        v
        外部主机
            1.1.1.1:* → 可回
            2.2.2.2:* → 被丢弃 ❌
```

### Port Restricted Cone NAT(端口限制锥形NAT)

内网主机发出请求后, 外部主机必须来自 同一个IP+同一个PORT才能访问回来.

```less
内网主机A(192.168.1.2:1234) → B(1.1.1.1:80)
        |
        | NAT 映射表：
        |   192.168.1.2:1234 → 203.0.113.5:50000
        v
    +-----------+
    | NAT网关   |
    +-----------+
        |
        v
        外部主机:
            1.1.1.1:80 → ✅ 允许
            1.1.1.1:81 → ❌ 拒绝
            2.2.2.2:*  → ❌ 拒绝
```

### Symmetric NAT(对称NAT)

每个外部主机目标地址, 都需要有一个独立的映射端口. NAT会根据外部目标地址和端口, 生成不同的映射端口.

```less
A(192.168.1.2:1234) → B(1.1.1.1:80)
NAT: 192.168.1.2:1234 → 203.0.113.5:50000

A(192.168.1.2:1234) → C(2.2.2.2:80)
NAT: 192.168.1.2:1234 → 203.0.113.5:50001

外部主机B → 203.0.113.5:50001 ❌ 无效
```

![nat-type](../assets/nat-type.png)

### 检测方法

```shell
sudo apt install stun-client    # Ubuntu / Debian
stun stun.l.google.com:19302
```
